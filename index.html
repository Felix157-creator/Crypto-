// ==================== GLOBAL STATE ====================
let currentUser = null;
let currentSymbol = 'BTCUSDT';
let currentLayer = 'welcomeLayer';
let selectedPaymentMethod = null;
let accountType = 'demo';
let demoBalance = 25.00;
let realBalance = 0.00;
let chartInstances = {};

// ==================== VALIDATION UTILITIES ====================
const Validators = {
    email: (email) => {
        const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return regex.test(email);
    },
    
    phone: (phone) => {
        // Accept various phone formats
        const regex = /^[\+]?[(]?[0-9]{3}[)]?[-\s\.]?[0-9]{3}[-\s\.]?[0-9]{4,6}$/;
        return regex.test(phone.replace(/\s/g, ''));
    },
    
    password: (password) => {
        return password.length >= 8;
    },
    
    name: (name) => {
        return name.length >= 2 && name.trim().length > 0;
    },
    
    amount: (amount, min = 10) => {
        const num = parseFloat(amount);
        return !isNaN(num) && num >= min;
    }
};

// ==================== ERROR HANDLING ====================
function showFieldError(fieldId, message) {
    const field = document.getElementById(fieldId);
    const errorDiv = document.getElementById(fieldId + 'Error');
    
    if (field && errorDiv) {
        field.classList.add('error');
        errorDiv.textContent = message;
        errorDiv.classList.add('show');
    }
}

function clearFieldError(fieldId) {
    const field = document.getElementById(fieldId);
    const errorDiv = document.getElementById(fieldId + 'Error');
    
    if (field && errorDiv) {
        field.classList.remove('error');
        errorDiv.classList.remove('show');
    }
}

function showAlert(elementId, message, type) {
    const alert = document.getElementById(elementId);
    if (alert) {
        alert.textContent = message;
        alert.className = `alert alert-${type} show`;
        setTimeout(() => {
            alert.classList.remove('show');
        }, 5000);
    }
}

// ==================== LAYER MANAGEMENT ====================
function showLayer(layerId) {
    document.querySelectorAll('.layer').forEach(layer => {
        layer.classList.remove('active');
    });
    
    const targetLayer = document.getElementById(layerId);
    if (targetLayer) {
        targetLayer.classList.add('active');
        currentLayer = layerId;
        
        // Initialize layer-specific content
        switch(layerId) {
            case 'chartsLayer':
                initChartsPage();
                break;
            case 'dashboardLayer':
                initDashboard();
                break;
            case 'tradingLayer':
                initTradingPage();
                break;
            case 'welcomeLayer':
                initWelcomePage();
                break;
        }
    }
}

// ==================== REFERRAL BANNER ====================
window.addEventListener('load', function() {
    try {
        const urlParams = new URLSearchParams(window.location.search);
        const referralCode = urlParams.get('ref');
        
        if (referralCode) {
            document.getElementById('signupReferralCode').value = referralCode;
            const referrerNames = ['John', 'Sarah', 'Michael', 'David', 'James', 'Emma', 'Felix', 'Mary'];
            const randomName = referrerNames[Math.floor(Math.random() * referrerNames.length)];
            document.getElementById('referrerName').textContent = randomName;
            document.getElementById('referralSuccessBanner').classList.add('show');
        }
        
        initWelcomePage();
    } catch (error) {
        console.error('Initialization error:', error);
    }
});

function closeReferralBanner() {
    document.getElementById('referralSuccessBanner').classList.remove('show');
}

// ==================== ACCOUNT TYPE MANAGEMENT ====================
function switchAccountType(type) {
    accountType = type;
    
    // Update all account type buttons
    document.querySelectorAll('.account-type-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    const buttons = {
        'demo': ['demoAccountBtn', 'tradingDemoBtn'],
        'real': ['realAccountBtn', 'tradingRealBtn']
    };
    
    buttons[type].forEach(btnId => {
        const btn = document.getElementById(btnId);
        if (btn) btn.classList.add('active');
    });
    
    const balance = type === 'demo' ? demoBalance : realBalance;
    const label = type === 'demo' ? 'DEMO BALANCE' : 'REAL BALANCE';
    updateBalanceDisplay(balance, label);
}

function updateBalanceDisplay(balance, label) {
    const elements = {
        'balanceAmount': balance,
        'balanceLabel': label,
        'tradingBalanceAmount': balance,
        'tradingBalanceLabel': label,
        'tradingAvailableBalance': balance,
        'modalAvailableBalance': balance,
        'dashAvailableBalance': balance,
        'withdrawAvailableBalance': accountType === 'real' ? realBalance : 0
    };
    
    for (const [id, value] of Object.entries(elements)) {
        const el = document.getElementById(id);
        if (el) {
            if (id.includes('Label')) {
                el.textContent = value;
            } else {
                const displayValue = typeof value === 'number' ? value.toFixed(2) : value;
                el.textContent = '$' + displayValue;
            }
        }
    }
}

// ==================== AUTHENTICATION ====================
function handleSignup(event) {
    event.preventDefault();
    
    // Clear previous errors
    ['signupName', 'signupEmail', 'signupPhone', 'signupPassword', 'signupConfirm'].forEach(clearFieldError);
    
    const name = document.getElementById('signupName').value.trim();
    const email = document.getElementById('signupEmail').value.trim();
    const phone = document.getElementById('signupPhone').value.trim();
    const password = document.getElementById('signupPassword').value;
    const confirm = document.getElementById('signupConfirm').value;
    const referralCode = document.getElementById('signupReferralCode').value.trim();
    const termsAccepted = document.getElementById('signupTerms').checked;
    
    let hasError = false;
    
    // Validate name
    if (!Validators.name(name)) {
        showFieldError('signupName', 'Please enter a valid name (min 2 characters)');
        hasError = true;
    }
    
    // Validate email
    if (!Validators.email(email)) {
        showFieldError('signupEmail', 'Please enter a valid email address');
        hasError = true;
    }
    
    // Validate phone
    if (!Validators.phone(phone)) {
        showFieldError('signupPhone', 'Please enter a valid phone number');
        hasError = true;
    }
    
    // Validate password
    if (!Validators.password(password)) {
        showFieldError('signupPassword', 'Password must be at least 8 characters');
        hasError = true;
    }
    
    // Validate password match
    if (password !== confirm) {
        showFieldError('signupConfirm', 'Passwords do not match');
        hasError = true;
    }
    
    // Validate terms
    if (!termsAccepted) {
        showAlert('signupAlert', '‚ùå Please accept Terms & Conditions', 'error');
        hasError = true;
    }
    
    if (hasError) {
        return false;
    }
    
    // Disable submit button
    const submitBtn = document.getElementById('signupBtn');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="loading-spinner"></span> Creating Account...';
    
    // Simulate account creation
    setTimeout(() => {
        const userCode = 'CRP' + Math.random().toString(36).substr(2, 6).toUpperCase();
        
        currentUser = {
            name,
            email,
            phone,
            referralCode: userCode,
            balance: 25,
            deposited: 0,
            profit: 0,
            referrals: [],
            referralEarnings: 0,
            createdAt: new Date().toISOString()
        };
        
        // Use sessionStorage for better security
        try {
            sessionStorage.setItem('cryptoproUser', JSON.stringify(currentUser));
            showAlert('signupAlert', '‚úÖ Account created successfully! Redirecting...', 'success');
            
            setTimeout(() => {
                showLayer('dashboardLayer');
            }, 2000);
        } catch (error) {
            console.error('Storage error:', error);
            showAlert('signupAlert', '‚ùå Failed to save account. Please try again.', 'error');
            submitBtn.disabled = false;
            submitBtn.textContent = 'üöÄ Create Account & Get $25 Bonus';
        }
    }, 1500);
    
    return false;
}

function handleLogin(event) {
    event.preventDefault();
    
    // Clear previous errors
    clearFieldError('loginEmail');
    clearFieldError('loginPassword');
    
    const email = document.getElementById('loginEmail').value.trim();
    const password = document.getElementById('loginPassword').value;
    
    let hasError = false;
    
    if (!Validators.email(email)) {
        showFieldError('loginEmail', 'Please enter a valid email address');
        hasError = true;
    }
    
    if (!password) {
        showFieldError('loginPassword', 'Please enter your password');
        hasError = true;
    }
    
    if (hasError) {
        return false;
    }
    
    const loginBtn = document.getElementById('loginBtn');
    loginBtn.disabled = true;
    loginBtn.innerHTML = '<span class="loading-spinner"></span> Logging in...';
    
    setTimeout(() => {
        try {
            const stored = sessionStorage.getItem('cryptoproUser');
            
            if (stored) {
                currentUser = JSON.parse(stored);
                
                if (currentUser.email === email) {
                    showAlert('loginAlert', '‚úÖ Login successful! Redirecting...', 'success');
                    setTimeout(() => {
                        showLayer('dashboardLayer');
                    }, 1500);
                } else {
                    showAlert('loginAlert', '‚ùå Invalid credentials! Please check your email and password.', 'error');
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'üîê Login';
                }
            } else {
                showAlert('loginAlert', '‚ùå No account found! Please sign up first.', 'error');
                loginBtn.disabled = false;
                loginBtn.textContent = 'üîê Login';
            }
        } catch (error) {
            console.error('Login error:', error);
            showAlert('loginAlert', '‚ùå Login failed. Please try again.', 'error');
            loginBtn.disabled = false;
            loginBtn.textContent = 'üîê Login';
        }
    }, 1000);
    
    return false;
}

function handleLogout() {
    if (confirm('Are you sure you want to logout?')) {
        currentUser = null;
        sessionStorage.removeItem('cryptoproUser');
        showLayer('welcomeLayer');
    }
}

// ==================== TRADING FUNCTIONS ====================
function checkBalanceAndTrade(tradeType) {
    if (accountType === 'real' && realBalance < 10) {
        showDepositRequiredAlert();
        return false;
    }
    showModal('tradeModal');
}

function showDepositRequiredAlert() {
    const alertHtml = `
        <div style="background: rgba(252, 213, 53, 0.1); border: 2px solid rgba(252, 213, 53, 0.3); border-radius: 16px; padding: 24px; text-align: center; margin: 20px; animation: slideIn 0.5s;">
            <div style="font-size: 48px; margin-bottom: 16px;">‚ö†Ô∏è</div>
            <h2 style="color: #FCD535; margin-bottom: 12px; font-size: 24px;">Deposit Required</h2>
            <p style="font-size: 16px; line-height: 1.6; margin-bottom: 20px;">
                To start trading with real money and make profits, you need to deposit funds first.
            </p>
            <p style="font-size: 18px; font-weight: 700; color: var(--accent-green); margin-bottom: 20px;">
                üí∞ Deposit now and get 100% WELCOME BONUS!
            </p>
            <button onclick="showLayer('depositLayer'); this.parentElement.parentElement.remove();" 
                style="padding: 16px 32px; background: linear-gradient(135deg, var(--accent-green), #0B8F5F); color: white; border: none; border-radius: 12px; font-size: 18px; font-weight: 700; cursor: pointer;">
                üí∏ Deposit Funds Now
            </button>
            <p style="font-size: 14px; color: var(--text-secondary); margin-top: 16px;">
                Or practice with Demo Account ($25 free balance)
            </p>
        </div>
    `;
    
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.innerHTML = `<div class="modal-content">${alertHtml}<button class="close-btn" onclick="this.parentElement.parentElement.remove()">√ó</button></div>`;
    modal.onclick = (e) => {
        if (e.target === modal) modal.remove();
    };
    document.body.appendChild(modal);
}

function executeTrade() {
    const amount = parseFloat(document.getElementById('tradeAmount').value);
    const pair = document.getElementById('tradePair').value;
    const type = document.getElementById('tradeType').value;
    const currentBalance = accountType === 'demo' ? demoBalance : realBalance;
    
    clearFieldError('tradeAmount');
    
    if (!Validators.amount(amount, 10)) {
        showFieldError('tradeAmount', 'Minimum trade amount is $10');
        return false;
    }
    
    if (amount > currentBalance) {
        showFieldError('tradeAmount', `Insufficient balance! You have $${currentBalance.toFixed(2)}`);
        return false;
    }
    
    if (accountType === 'real' && realBalance < 10) {
        showTradeAlert('‚ö†Ô∏è Please deposit funds to trade on real account', 'warning');
        setTimeout(() => {
            closeModal('tradeModal');
            showDepositRequiredAlert();
        }, 2000);
        return false;
    }
    
    // Deduct from appropriate balance
    if (accountType === 'demo') {
        demoBalance -= amount;
    } else {
        realBalance -= amount;
    }
    
    updateBalanceDisplay(accountType === 'demo' ? demoBalance : realBalance, 
                        accountType === 'demo' ? 'DEMO BALANCE' : 'REAL BALANCE');
    
    showTradeAlert(`‚úÖ Trade Executed Successfully!\n\nPair: ${pair}\nType: ${type}\nAmount: $${amount.toFixed(2)}\n\nYour trade is now active.`, 'success');
    
    setTimeout(() => {
        closeModal('tradeModal');
    }, 3000);
    
    return false;
}

function showTradeAlert(message, type) {
    const alert = document.getElementById('tradeModalAlert');
    if (alert) {
        alert.textContent = message;
        alert.className = `alert alert-${type} show`;
    }
}

// ==================== WELCOME PAGE INITIALIZATION ====================
function initWelcomePage() {
    generateLiveTraders();
    generateTopWinners();
    setInterval(generateLiveTraders, 5000);
}

function generateLiveTraders() {
    const names = ['Felix K.', 'Sarah M.', 'John D.', 'Mary W.', 'David O.', 'Emma N.', 'James K.', 'Fatima A.', 'Michael O.', 'Amina B.'];
    const countries = ['üá∞üá™ Kenya', 'üá≥üá¨ Nigeria', 'üáøüá¶ South Africa', 'üá™üá¨ Egypt', 'üá¨üá≠ Ghana', 'üáπüáø Tanzania'];
    const emojis = ['üë®', 'üë©', 'üßë', 'üë®‚Äçüíº', 'üë©‚Äçüíº'];
    
    let html = '';
    for (let i = 0; i < 20; i++) {
        const name = names[Math.floor(Math.random() * names.length)];
        const country = countries[Math.floor(Math.random() * countries.length)];
        const emoji = emojis[Math.floor(Math.random() * emojis.length)];
        const profit = (Math.random() * 500 + 50).toFixed(2);
        
        html += `
            <div class="trader-card">
                <div class="trader-avatar">${emoji}</div>
                <div class="trader-info">
                    <div class="trader-name">${name} ‚Ä¢ ${country}</div>
                    <div class="trader-profit">+$${profit}</div>
                </div>
            </div>
        `;
    }
    
    const ticker = document.getElementById('liveTradersTicker');
    if (ticker) {
        ticker.innerHTML = html + html;
    }
}

function generateTopWinners() {
    const winners = [
        { rank: 1, name: 'Felix K.', location: 'Nairobi, Kenya', emoji: 'üë®', profit: '$12,450', trades: '1,234' },
        { rank: 2, name: 'Sarah M.', location: 'Lagos, Nigeria', emoji: 'üë©', profit: '$9,820', trades: '987' },
        { rank: 3, name: 'Michael O.', location: 'Johannesburg, SA', emoji: 'üë®', profit: '$8,650', trades: '856' },
        { rank: 4, name: 'Amina B.', location: 'Cairo, Egypt', emoji: 'üë©', profit: '$7,340', trades: '734' },
        { rank: 5, name: 'David N.', location: 'Accra, Ghana', emoji: 'üë®', profit: '$6,890', trades: '689' },
        { rank: 6, name: 'Emma W.', location: 'Kigali, Rwanda', emoji: 'üë©', profit: '$5,720', trades: '572' }
    ];
    
    let html = '';
    winners.forEach(winner => {
        html += `
            <div class="winner-card">
                <div class="winner-rank">${winner.rank}</div>
                <div class="winner-header">
                    <div class="winner-avatar-large">${winner.emoji}</div>
                    <div class="winner-details">
                        <h4>${winner.name}</h4>
                        <div class="winner-location">${winner.location}</div>
                    </div>
                </div>
                <div class="winner-stats">
                    <div class="winner-stat">
                        <div class="winner-stat-label">Total Profit</div>
                        <div class="winner-stat-value">${winner.profit}</div>
                    </div>
                    <div class="winner-stat">
                        <div class="winner-stat-label">Trades</div>
                        <div class="winner-stat-value">${winner.trades}</div>
                    </div>
                </div>
            </div>
        `;
    });
    
    const grid = document.getElementById('topWinnersGrid');
    if (grid) {
        grid.innerHTML = html;
    }
}

// ==================== CHART GENERATION WITH CHART.JS ====================
function destroyChart(chartId) {
    if (chartInstances[chartId]) {
        chartInstances[chartId].destroy();
        delete chartInstances[chartId];
    }
}

function createLineChart(canvasId, data, color, label) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    
    destroyChart(canvasId);
    
    const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
    gradient.addColorStop(0, color + '80');
    gradient.addColorStop(1, color + '00');
    
    chartInstances[canvasId] = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.map((_, i) => ''),
            datasets: [{
                label: label,
                data: data,
                borderColor: color,
                backgroundColor: gradient,
                borderWidth: 2,
                fill: true,
                tension: 0.4,
                pointRadius: 0,
                pointHoverRadius: 4,
                pointBackgroundColor: color,
                pointBorderColor: '#fff',
                pointBorderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#fff',
                    bodyColor: '#fff',
                    borderColor: color,
                    borderWidth: 1
                }
            },
            scales: {
                x: {
                    display: false
                },
                y: {
                    display: true,
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)',
                        drawBorder: false
                    },
                    ticks: {
                        color: 'rgba(255, 255, 255, 0.5)',
                        font: {
                            size: 10
                        }
                    }
                }
            },
            interaction: {
                mode: 'nearest',
                axis: 'x',
                intersect: false
            }
        }
    });
}

function generateChartData(points, baseValue, variance) {
    const data = [];
    let current = baseValue;
    
    for (let i = 0; i < points; i++) {
        const change = (Math.random() - 0.5) * variance;
        current += change;
        data.push(current);
    }
    
    return data;
}

function initChartsPage() {
    updatePriceData('charts');
    
    const priceData = generateChartData(50, 98000, 2000);
    const volumeData = generateChartData(50, 1000000, 200000);
    const rsiData = generateChartData(50, 50, 10);
    
    createLineChart('chartsPriceCanvas', priceData, '#0ECB81', 'Price');
    createLineChart('chartsVolumeCanvas', volumeData, '#00d9ff', 'Volume');
    createLineChart('chartsRsiCanvas', rsiData, '#FCD535', 'RSI');
    
    generateOrderBook('charts');
    generateRecentTrades('charts');
    
    const updateInterval = setInterval(() => {
        if (currentLayer !== 'chartsLayer') {
            clearInterval(updateInterval);
            return;
        }
        updatePriceData('charts');
        generateOrderBook('charts');
        generateRecentTrades('charts');
    }, 3000);
}

function initDashboard() {
    if (currentUser) {
        document.getElementById('userName').textContent = currentUser.name;
        document.getElementById('userEmail').textContent = currentUser.email;
        
        const userLink = `https://cryptopro.com/ref/${currentUser.referralCode}`;
        const linkEl = document.getElementById('userReferralLink');
        if (linkEl) {
            linkEl.textContent = userLink;
        }
    }
    
    updatePriceData('dash');
    
    const priceData = generateChartData(30, 98000, 1500);
    createLineChart('dashPriceCanvas', priceData, '#0ECB81', 'Price');
    
    const updateInterval = setInterval(() => {
        if (currentLayer !== 'dashboardLayer') {
            clearInterval(updateInterval);
            return;
        }
        updatePriceData('dash');
    }, 3000);
}

function initTradingPage() {
    updatePriceData('trading');
    
    const priceData = generateChartData(50, 98000, 2000);
    const volumeData = generateChartData(50, 1000000, 200000);
    const rsiData = generateChartData(50, 50, 10);
    
    createLineChart('tradingPriceCanvas', priceData, '#0ECB81', 'Price');
    createLineChart('tradingVolumeCanvas', volumeData, '#00d9ff', 'Volume');
    createLineChart('tradingRsiCanvas', rsiData, '#FCD535', 'RSI');
    
    generateOrderBook('trading');
    generateRecentTrades('trading');
    
    const updateInterval = setInterval(() => {
        if (currentLayer !== 'tradingLayer') {
            clearInterval(updateInterval);
            return;
        }
        updatePriceData('trading');
        generateOrderBook('trading');
        generateRecentTrades('trading');
    }, 3000);
}

function updatePriceData(prefix) {
    const basePrice = 98000 + (Math.random() - 0.5) * 1000;
    const change = ((Math.random() - 0.4) * 5).toFixed(2);
    
    const mainPrice = document.getElementById(`${prefix}MainPrice`);
    const mainChange = document.getElementById(`${prefix}MainChange`);
    
    if (mainPrice) mainPrice.textContent = `$${basePrice.toFixed(2)}`;
    if (mainChange) {
        mainChange.textContent = `${change >= 0 ? '+' : ''}${change}%`;
        mainChange.className = `price-change ${change >= 0 ? 'positive' : 'negative'}`;
    }
    
    const high = document.getElementById(`${prefix}Stat24hHigh`);
    const low = document.getElementById(`${prefix}Stat24hLow`);
    const volume = document.getElementById(`${prefix}Stat24hVolume`);
    const marketCap = document.getElementById(`${prefix}StatMarketCap`);
    
    if (high) high.textContent = `$${(basePrice + 1000).toFixed(0)}`;
    if (low) low.textContent = `$${(basePrice - 1000).toFixed(0)}`;
    if (volume) volume.textContent = `${(Math.random() * 10 + 20).toFixed(1)}B`;
    if (marketCap) marketCap.textContent = `$${(Math.random() * 0.1 + 1.9).toFixed(2)}T`;
}

function generateOrderBook(prefix) {
    const basePrice = 98000;
    let asksHtml = '';
    let bidsHtml = '';
    
    for (let i = 0; i < 10; i++) {
        const askPrice = (basePrice + i * 10 + Math.random() * 10).toFixed(2);
        const bidPrice = (basePrice - i * 10 - Math.random() * 10).toFixed(2);
        const amount = (Math.random() * 0.5 + 0.1).toFixed(4);
        const total = (askPrice * amount).toFixed(2);
        
        asksHtml += `
            <div class="orderbook-row">
                <div class="price-ask">${askPrice}</div>
                <div>${amount}</div>
                <div>${total}</div>
            </div>
        `;
        
        bidsHtml += `
            <div class="orderbook-row">
                <div class="price-bid">${bidPrice}</div>
                <div>${amount}</div>
                <div>${total}</div>
            </div>
        `;
    }
    
    const askContainer = document.getElementById(`${prefix}AskOrdersContainer`);
    const bidContainer = document.getElementById(`${prefix}BidOrdersContainer`);
    
    if (askContainer) askContainer.innerHTML = asksHtml;
    if (bidContainer) bidContainer.innerHTML = bidsHtml;
    
    const spreadValue = document.getElementById(`${prefix}SpreadValue`);
    const spreadPercent = document.getElementById(`${prefix}SpreadPercent`);
    
    if (spreadValue) spreadValue.textContent = (Math.random() * 50 + 20).toFixed(2);
    if (spreadPercent) spreadPercent.textContent = (Math.random() * 0.05 + 0.02).toFixed(3) + '%';
}

function generateRecentTrades(prefix) {
    let html = '';
    const basePrice = 98000;
    
    for (let i = 0; i < 15; i++) {
        const price = (basePrice + (Math.random() - 0.5) * 100).toFixed(2);
        const amount = (Math.random() * 0.5 + 0.05).toFixed(4);
        const time = new Date(Date.now() - i * 3000).toLocaleTimeString();
        const isBuy = Math.random() > 0.5;
        
        html += `
            <div class="trade-row">
                <div class="${isBuy ? 'price-bid' : 'price-ask'}">${price}</div>
                <div>${amount}</div>
                <div style="color: var(--text-secondary); font-size: 11px;">${time}</div>
            </div>
        `;
    }
    
    const container = document.getElementById(`${prefix}RecentTradesContainer`);
    if (container) container.innerHTML = html;
}

// ==================== PAYMENT METHODS ====================
function selectPaymentMethod(method, event) {
    if (event) event.preventDefault();
    
    selectedPaymentMethod = method;
    
    document.querySelectorAll('.payment-method-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    if (event && event.target) {
        event.target.classList.add('active');
    }
    
    document.getElementById('mpesaDetails').style.display = 'none';
    document.getElementById('cryptoDetails').style.display = 'none';
    document.getElementById('bankDetails').style.display = 'none';
    
    if (method === 'mpesa') document.getElementById('mpesaDetails').style.display = 'block';
    if (method === 'crypto') document.getElementById('cryptoDetails').style.display = 'block';
    if (method === 'bank') document.getElementById('bankDetails').style.display = 'block';
}

function processDeposit(event) {
    event.preventDefault();
    
    const amount = document.getElementById('depositAmount').value;
    const proof = document.getElementById('depositProof').value.trim();
    
    clearFieldError('depositAmount');
    
    if (!Validators.amount(amount, 10)) {
        showFieldError('depositAmount', 'Minimum deposit is $10');
        return false;
    }
    
    if (!selectedPaymentMethod) {
        alert('‚ùå Please select a payment method!');
        return false;
    }
    
    if (!proof) {
        alert('‚ùå Please provide payment proof!');
        return false;
    }
    
    const depositBtn = document.getElementById('depositBtn');
    depositBtn.disabled = true;
    depositBtn.innerHTML = '<span class="loading-spinner"></span> Submitting...';
    
    setTimeout(() => {
        alert(`‚úÖ Deposit request submitted!\n\nAmount: $${amount}\nMethod: ${selectedPaymentMethod}\n\nYour deposit will be verified and credited within 1-10 minutes.\n\nContact support on WhatsApp for faster processing.`);
        showLayer('dashboardLayer');
    }, 1500);
    
    return false;
}

function processWithdraw(event) {
    event.preventDefault();
    
    const amount = document.getElementById('withdrawAmount').value;
    const method = document.getElementById('withdrawMethod').value;
    const account = document.getElementById('withdrawAccount').value.trim();
    
    clearFieldError('withdrawAmount');
    clearFieldError('withdrawAccount');
    
    if (!Validators.amount(amount, 10)) {
        showFieldError('withdrawAmount', 'Minimum withdrawal is $10');
        return false;
    }
    
    if (parseFloat(amount) > realBalance) {
        showFieldError('withdrawAmount', `Insufficient balance! Available: $${realBalance.toFixed(2)}`);
        return false;
    }
    
    if (!account) {
        showFieldError('withdrawAccount', 'Please provide account details');
        return false;
    }
    
    const withdrawBtn = document.getElementById('withdrawBtn');
    withdrawBtn.disabled = true;
    withdrawBtn.innerHTML = '<span class="loading-spinner"></span> Processing...';
    
    setTimeout(() => {
        alert(`‚úÖ Withdrawal request submitted!\n\nAmount: $${amount}\nMethod: ${method}\nAccount: ${account}\n\nProcessing time: 1-24 hours\n\nYou will receive a confirmation message shortly.`);
        showLayer('dashboardLayer');
    }, 1500);
    
    return false;
}

// ==================== MODAL MANAGEMENT ====================
function showModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
    }
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.remove('active');
        document.body.style.overflow = '';
    }
}

// ==================== UTILITY FUNCTIONS ====================
function copyToClipboard(text, label) {
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(() => {
            alert(`‚úÖ ${label} copied to clipboard!\n\n${text}`);
        }).catch(err => {
            console.error('Failed to copy:', err);
            fallbackCopyTextToClipboard(text, label);
        });
    } else {
        fallbackCopyTextToClipboard(text, label);
    }
}

function fallbackCopyTextToClipboard(text, label) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.top = '0';
    textArea.style.left = '0';
    textArea.style.opacity = '0';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        const successful = document.execCommand('copy');
        if (successful) {
            alert(`‚úÖ ${label} copied to clipboard!\n\n${text}`);
        }
    } catch (err) {
        alert(`‚ùå Failed to copy. Please copy manually: ${text}`);
    }
    
    document.body.removeChild(textArea);
}

function copyReferralLink() {
    const link = document.getElementById('userReferralLink');
    if (link) {
        copyToClipboard(link.textContent, 'Referral Link');
    }
}

function shareViaWhatsApp() {
    const link = document.getElementById('userReferralLink');
    if (!link) return;
    
    const message = `üöÄ Join me on CryptoPro and get $25 FREE bonus!\n\nI'm making consistent profits with AI-powered crypto trading.\n\nSign up now: ${link.textContent}\n\n‚úÖ $25 instant bonus\n‚úÖ 100% withdrawable\n‚úÖ 24/7 support`;
    
    const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
    window.open(whatsappUrl, '_blank');
}

// ==================== SYMBOL CHANGE HANDLERS ====================
document.addEventListener('DOMContentLoaded', function() {
    const selects = ['chartsSymbolSelect', 'dashSymbolSelect', 'tradingSymbolSelect'];
    
    selects.forEach(selectId => {
        const select = document.getElementById(selectId);
        if (select) {
            select.addEventListener('change', function() {
                currentSymbol = this.value;
                const prefix = selectId.replace('SymbolSelect', '');
                updatePriceData(prefix);
                
                const icons = {
                    'BTCUSDT': '‚Çø',
                    'ETHUSDT': 'Œû',
                    'BNBUSDT': 'B',
                    'SOLUSDT': 'S',
                    'XRPUSDT': 'X',
                    'ADAUSDT': 'A'
                };
                
                const iconEl = document.getElementById(`${prefix}PairIcon`);
                if (iconEl) iconEl.textContent = icons[currentSymbol] || '‚Çø';
            });
        }
    });
    
    // Close modals when clicking outside
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeModal(modal.id);
            }
        });
    });
});

// ==================== ERROR BOUNDARY ====================
window.addEventListener('error', function(event) {
    console.error('Application error:', event.error);
    // Could add user-friendly error notification here
});

window.addEventListener('unhandledrejection', function(event) {
    console.error('Unhandled promise rejection:', event.reason);
});
