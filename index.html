<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CryptoPro All-in-One</title>
<style>
body {margin:0;font-family:Arial,sans-serif;background:#0f172a;color:#e5e7eb;}
header{background:#020617;padding:15px;text-align:center;font-weight:bold;font-size:20px;}
nav{display:flex;justify-content:space-around;background:#020617;padding:10px;}
nav button{background:none;border:none;color:#38bdf8;font-size:14px;cursor:pointer;}
.container{padding:20px;}
.card{background:#020617;padding:15px;border-radius:10px;margin-bottom:15px;}
input, select, button{width:100%;padding:10px;margin-top:8px;border-radius:6px;border:none;font-size:14px;}
button{background:#38bdf8;color:#020617;font-weight:bold;cursor:pointer;}
.hidden{display:none;}
.success{color:#22c55e;}
.error{color:#ef4444;}
table {width:100%;border-collapse:collapse;margin-top:15px;}
th,td {border:1px solid #38bdf8;padding:8px;text-align:center;}
th {background:#020617;}
td {background:#1e293b;}
button.action{padding:5px 10px;border:none;border-radius:5px;cursor:pointer;}
.approve{background:#22c55e;color:#020617;}
.reject{background:#ef4444;color:#fff;}
.tab-header{margin-top:10px;display:flex;justify-content:center;gap:10px;}
.tab-header button{padding:8px 12px;background:#020617;color:#38bdf8;border:none;border-radius:6px;cursor:pointer;}
.tab-header button.active{background:#38bdf8;color:#020617;}
</style>
</head>
<body>

<header>CryptoPro Investment Platform</header>

<div class="tab-header">
  <button id="tabUser" class="active" onclick="switchTab('user')">User Dashboard</button>
  <button id="tabAdmin" onclick="switchTab('admin')">Admin Panel</button>
</div>

<div class="container">

<!-- ========== USER DASHBOARD ========== -->
<div id="userTab">
  <nav>
    <button onclick="show('dashboard')">Dashboard</button>
    <button onclick="show('deposit')">Deposit</button>
    <button onclick="show('withdraw')">Withdraw</button>
    <button onclick="show('trading')">Trading</button>
  </nav>

  <div id="dashboard" class="card">
    <h3>Account Overview</h3>
    <p>Balance: <strong>$<span id="balance">0.00</span></strong></p>
    <p>Status: Active</p>
  </div>

  <div id="deposit" class="card hidden">
    <h3>Deposit Funds (USD)</h3>
    <input type="number" id="depositAmount" placeholder="Amount in USD" />
    <select id="depositMethod">
      <option>MPesa</option>
      <option>Airtel Money</option>
      <option>Bank Transfer</option>
      <option>Card</option>
      <option>Crypto</option>
    </select>
    <button onclick="deposit()">Proceed to Pay</button>
    <p id="depositMsg"></p>
  </div>

  <div id="withdraw" class="card hidden">
    <h3>Request Withdrawal</h3>
    <input type="number" id="withdrawAmount" placeholder="Amount in USD" />
    <select id="withdrawMethod">
      <option>MPesa</option>
      <option>Airtel Money</option>
      <option>Bank</option>
      <option>Crypto</option>
    </select>
    <input type="text" id="withdrawDest" placeholder="Phone / Account / Wallet" />
    <button onclick="withdraw()">Request Withdrawal</button>
    <p id="withdrawMsg"></p>
  </div>

  <div id="trading" class="card hidden">
    <h3>Trading Bots (Simulation)</h3>
    <p>Daily ROI: 0.5% â€“ 2%</p>
    <p>Today's Profit: <strong class="success">$<span id="profit">0.00</span></strong></p>
    <button onclick="simulateProfit()">Run Today's Simulation</button>
  </div>
</div>

<!-- ========== ADMIN PANEL ========== -->
<div id="adminTab" class="hidden">

  <nav>
    <button onclick="showAdmin('users')">Users</button>
    <button onclick="showAdmin('withdrawals')">Withdrawals</button>
  </nav>

  <div id="users" class="hidden">
    <h3>Users Overview</h3>
    <table>
      <thead>
        <tr><th>User ID</th><th>Balance</th><th>Action</th></tr>
      </thead>
      <tbody id="usersTable"></tbody>
    </table>
  </div>

  <div id="withdrawals">
    <h3>Pending Withdrawals</h3>
    <table>
      <thead>
        <tr><th>User ID</th><th>Amount</th><th>Method</th><th>Destination</th><th>Action</th></tr>
      </thead>
      <tbody id="withdrawTable"></tbody>
    </table>
  </div>

</div>

</div>

<script>
// --------- TAB SWITCHING ---------
function switchTab(tab){
  if(tab==='user'){
    document.getElementById('userTab').classList.remove('hidden');
    document.getElementById('adminTab').classList.add('hidden');
    document.getElementById('tabUser').classList.add('active');
    document.getElementById('tabAdmin').classList.remove('active');
  } else {
    document.getElementById('adminTab').classList.remove('hidden');
    document.getElementById('userTab').classList.add('hidden');
    document.getElementById('tabAdmin').classList.add('active');
    document.getElementById('tabUser').classList.remove('active');
    showAdmin('withdrawals');
  }
}

// --------- USER DASHBOARD ---------
let user = { id: localStorage.userId || "demo-user-001", balance: 0, todayProfit: 0 };

function show(id){
  ["dashboard","deposit","withdraw","trading"].forEach(s=>document.getElementById(s).classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
  refresh();
}

function refresh(){
  document.getElementById("balance").innerText=user.balance.toFixed(2);
  document.getElementById("profit").innerText=user.todayProfit.toFixed(2);
}

async function refreshBalance(){
  try{
    const res = await fetch(`/api/get-user-balance?userId=${user.id}`);
    const data = await res.json();
    if(data.balance!==undefined) user.balance=Number(data.balance);
    refresh();
  }catch(err){console.error(err);}
}

async function deposit(){
  const amt=Number(document.getElementById("depositAmount").value);
  const method=document.getElementById("depositMethod").value;
  if(!amt||amt<=0) return;
  try{
    const res=await fetch("/api/start-deposit",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:user.id,amount:amt,method})});
    const data=await res.json();
    if(data.payment_url) window.location.href=data.payment_url;
    else document.getElementById("depositMsg").innerHTML="<span class='error'>Payment initiation failed</span>";
  }catch(err){document.getElementById("depositMsg").innerHTML="<span class='error'>Server error</span>";}
}

async function withdraw(){
  const amt=Number(document.getElementById("withdrawAmount").value);
  const method=document.getElementById("withdrawMethod").value;
  const dest=document.getElementById("withdrawDest").value;
  if(!amt||amt<=0||!dest) return;
  try{
    const res=await fetch("/api/request-withdrawal",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:user.id,amount:amt,method,destination:dest})});
    const data=await res.json();
    if(data.success){document.getElementById("withdrawMsg").innerHTML="<span class='success'>Withdrawal request sent for admin approval</span>";await refreshBalance();}
    else document.getElementById("withdrawMsg").innerHTML="<span class='error'>"+data.error+"</span>";
  }catch(err){document.getElementById("withdrawMsg").innerHTML="<span class='error'>Server error</span>";}
}

async function simulateProfit(){
  try{
    const res=await fetch("/api/run-bots",{method:"POST",headers:{"Content-Type":"application/json"}});
    const data=await res.json();
    await refreshBalance();
    user.todayProfit=data.profit||0;
    refresh();
  }catch(err){console.error("Bot error",err);}
}

// --------- ADMIN PANEL ---------
function showAdmin(id){
  ["users","withdrawals"].forEach(s=>document.getElementById(s).classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
  if(id==="users") loadUsers();
  if(id==="withdrawals") loadWithdrawals();
}

async function loadUsers(){
  try{
    const res=await fetch("/api/get-all-users");
    const data=await res.json();
    const tbody=document.getElementById("usersTable");
    tbody.innerHTML="";
    data.forEach(u=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${u.id}</td><td>$${u.balance.toFixed(2)}</td><td><button class="action" onclick="creditUser('${u.id}')">Credit</button></td>`;
      tbody.appendChild(tr);
    });
  }catch(err){console.error(err);}
}

async function creditUser(userId){
  const amt=prompt("Enter amount to credit:");
  if(!amt) return;
  try{
    await fetch("/api/credit-user",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({uid:userId,amt:Number(amt)})});
    alert("User credited successfully!");
    loadUsers();
  }catch(err){console.error(err);}
}

async function loadWithdrawals(){
  try{
    const res=await fetch("/api/get-pending-withdrawals");
    const data=await res.json();
    const tbody=document.getElementById("withdrawTable");
    tbody.innerHTML="";
    data.forEach(w=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${w.user_id}</td><td>$${w.amount}</td><td>${w.method}</td><td>${w.destination}</td>
      <td><button class="action approve" onclick="approve('${w.id}')">Approve</button>
      <button class="action reject" onclick="reject('${w.id}')">Reject</button></td>`;
      tbody.appendChild(tr);
    });
  }catch(err){console.error(err);}
}

async function approve(id){
  try{
    await fetch("/api/admin-approve",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id})});
    alert("Withdrawal approved!");
    loadWithdrawals();
  }catch(err){console.error(err);}
}

async function reject(id){
  try{
    await fetch("/api/admin-reject",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id})});
    alert("Withdrawal rejected!");
    loadWithdrawals();
  }catch(err){console.error(err);}
}

// Initialize
document.addEventListener("DOMContentLoaded",refreshBalance);
</script>

</body>
</html>
