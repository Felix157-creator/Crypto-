// ==================== BACKEND API EXAMPLE ====================
// This is a Node.js/Express backend example showing how to handle
// payments from ANY source and auto-convert to USDT for your Binance

const express = require('express');
const app = express();

// ==================== CONFIGURATION ====================
const BACKEND_CONFIG = {
    BINANCE_ADDRESS: 'TK4rUz6TUEd7zCWeuiX5R47pSNdPswJnAc',
    ADMIN_WALLET_NOTIFICATION_EMAIL: 'youremail@example.com',
    
    // Payment Gateway API Keys (You need to register and get these)
    FLUTTERWAVE_SECRET: 'YOUR_FLUTTERWAVE_SECRET_KEY',
    STRIPE_SECRET: 'YOUR_STRIPE_SECRET_KEY',
    NOWPAYMENTS_API_KEY: 'YOUR_NOWPAYMENTS_API_KEY',
    
    // Exchange Rates (Updated every 5 minutes from API)
    EXCHANGE_RATES: {
        KES: 0.0076,  // Kenyan Shilling to USD
        UGX: 0.00026, // Ugandan Shilling to USD
        TZS: 0.00038, // Tanzanian Shilling to USD
        NGN: 0.00063, // Nigerian Naira to USD
        GHS: 0.078,   // Ghanaian Cedi to USD
        ZAR: 0.052,   // South African Rand to USD
        BTC: 64250,   // Bitcoin to USD
        ETH: 3420,    // Ethereum to USD
    }
};

// ==================== HELPER FUNCTIONS ====================

// Convert any currency to USD
function convertToUSD(amount, currency) {
    const rate = BACKEND_CONFIG.EXCHANGE_RATES[currency];
    if (!rate) return null;
    
    if (currency === 'BTC' || currency === 'ETH') {
        // For crypto, divide by rate
        return amount * rate;
    } else {
        // For fiat, multiply by rate
        return amount * rate;
    }
}

// Buy USDT with USD (via exchange or payment processor)
async function buyUSDT(usdAmount) {
    // This would call your exchange API (Binance, Coinbase, etc.)
    // Or use a payment processor like NOWPayments
    
    // Simplified example:
    return {
        success: true,
        amountUSDT: usdAmount,
        transactionId: 'TXN' + Date.now()
    };
}

// Send USDT to your Binance address
async function sendUSDTToBinance(amountUSDT, memo = '') {
    // This would call Binance API or payment processor
    // to send USDT to your address
    
    console.log(`Sending ${amountUSDT} USDT to ${BACKEND_CONFIG.BINANCE_ADDRESS}`);
    
    // Simplified - in reality, you'd call an API
    return {
        success: true,
        txHash: '0x' + Math.random().toString(36).substr(2, 64),
        amount: amountUSDT,
        destination: BACKEND_CONFIG.BINANCE_ADDRESS
    };
}

// Update user balance in your database
async function creditUserAccount(userId, usdAmount, transactionId) {
    // This updates your user database
    console.log(`Crediting user ${userId} with $${usdAmount}`);
    
    // Save to database
    const transaction = {
        userId: userId,
        amount: usdAmount,
        type: 'DEPOSIT',
        status: 'COMPLETED',
        transactionId: transactionId,
        timestamp: new Date()
    };
    
    // db.transactions.insert(transaction);
    // db.users.update({id: userId}, {$inc: {balance: usdAmount}});
    
    return transaction;
}

// Send notification email
async function notifyAdmin(message) {
    console.log('ADMIN NOTIFICATION:', message);
    // Send email using nodemailer or similar
}

// ==================== API ENDPOINTS ====================

// 1. MOBILE MONEY DEPOSIT (M-Pesa, Airtel, MTN)
app.post('/api/deposit/mobile-money', async (req, res) => {
    try {
        const { userId, phoneNumber, amount, currency, provider } = req.body;
        // amount in local currency (e.g., 1000 KES)
        
        // Step 1: Initiate mobile money payment via Flutterwave
        const Flutterwave = require('flutterwave-node-v3');
        const flw = new Flutterwave(process.env.FLW_PUBLIC_KEY, BACKEND_CONFIG.FLUTTERWAVE_SECRET);
        
        const payment = await flw.MobileMoney[provider.toLowerCase()]({
            tx_ref: 'TXN-' + Date.now(),
            amount: amount,
            currency: currency,
            email: `user${userId}@cryptopro.com`,
            phone_number: phoneNumber,
            fullname: `User ${userId}`
        });
        
        if (payment.status === 'success') {
            // Step 2: Convert to USD
            const usdAmount = convertToUSD(amount, currency);
            
            // Step 3: Buy USDT
            const usdtResult = await buyUSDT(usdAmount);
            
            // Step 4: Send to Binance
            const transferResult = await sendUSDTToBinance(usdtResult.amountUSDT, `Deposit from User ${userId}`);
            
            // Step 5: Credit user account
            await creditUserAccount(userId, usdAmount, transferResult.txHash);
            
            // Step 6: Notify admin
            await notifyAdmin(`New deposit: ${amount} ${currency} = $${usdAmount} from User ${userId}`);
            
            res.json({
                success: true,
                message: 'Deposit successful',
                usdAmount: usdAmount,
                originalAmount: amount,
                originalCurrency: currency,
                transactionId: transferResult.txHash
            });
        } else {
            res.status(400).json({ success: false, message: 'Payment failed' });
        }
        
    } catch (error) {
        console.error('Mobile money deposit error:', error);
        res.status(500).json({ success: false, message: error.message });
    }
});

// 2. CARD DEPOSIT (Visa/Mastercard via Stripe)
app.post('/api/deposit/card', async (req, res) => {
    try {
        const { userId, amount, cardToken } = req.body;
        // amount in USD
        
        // Step 1: Charge card via Stripe
        const stripe = require('stripe')(BACKEND_CONFIG.STRIPE_SECRET);
        
        const charge = await stripe.charges.create({
            amount: Math.round(amount * 100), // Convert to cents
            currency: 'usd',
            source: cardToken,
            description: `CryptoPro deposit for User ${userId}`
        });
        
        if (charge.status === 'succeeded') {
            // Step 2: Buy USDT
            const usdtResult = await buyUSDT(amount);
            
            // Step 3: Send to Binance
            const transferResult = await sendUSDTToBinance(usdtResult.amountUSDT, `Card deposit User ${userId}`);
            
            // Step 4: Credit user
            await creditUserAccount(userId, amount, transferResult.txHash);
            
            // Step 5: Notify
            await notifyAdmin(`Card deposit: $${amount} from User ${userId}`);
            
            res.json({
                success: true,
                message: 'Card payment successful',
                amount: amount,
                transactionId: transferResult.txHash
            });
        } else {
            res.status(400).json({ success: false, message: 'Card payment failed' });
        }
        
    } catch (error) {
        console.error('Card deposit error:', error);
        res.status(500).json({ success: false, message: error.message });
    }
});

// 3. CRYPTO DEPOSIT (Direct USDT or other crypto)
app.post('/api/deposit/crypto', async (req, res) => {
    try {
        const { userId, amount, currency, txHash } = req.body;
        
        if (currency === 'USDT') {
            // Direct USDT - already in correct format
            // Just verify transaction on blockchain
            
            // Credit user directly
            await creditUserAccount(userId, amount, txHash);
            
            res.json({
                success: true,
                message: 'USDT deposit confirmed',
                amount: amount,
                transactionId: txHash
            });
            
        } else {
            // Other crypto (BTC, ETH, etc.) - need to convert
            
            // Step 1: Verify transaction on blockchain
            // (Check if BTC/ETH was received)
            
            // Step 2: Convert to USD
            const usdAmount = convertToUSD(amount, currency);
            
            // Step 3: Exchange for USDT
            const usdtResult = await buyUSDT(usdAmount);
            
            // Step 4: Send to Binance
            const transferResult = await sendUSDTToBinance(usdtResult.amountUSDT, `Crypto deposit User ${userId}`);
            
            // Step 5: Credit user
            await creditUserAccount(userId, usdAmount, transferResult.txHash);
            
            res.json({
                success: true,
                message: 'Crypto converted and deposited',
                originalAmount: amount,
                originalCurrency: currency,
                usdAmount: usdAmount,
                transactionId: transferResult.txHash
            });
        }
        
    } catch (error) {
        console.error('Crypto deposit error:', error);
        res.status(500).json({ success: false, message: error.message });
    }
});

// 4. WEBHOOK FOR NOWPAYMENTS (Handles all crypto payments automatically)
app.post('/webhook/nowpayments', async (req, res) => {
    try {
        const { payment_status, price_amount, pay_amount, pay_currency, order_id } = req.body;
        
        if (payment_status === 'finished') {
            // Payment confirmed - NOWPayments already converted to USDT
            // and sent to your Binance address automatically
            
            const userId = order_id.split('-')[1]; // Extract user ID from order
            const usdAmount = price_amount;
            
            // Just credit the user
            await creditUserAccount(userId, usdAmount, req.body.payment_id);
            
            // Notify admin
            await notifyAdmin(`NOWPayments: ${pay_amount} ${pay_currency} = $${usdAmount} for User ${userId}`);
            
            res.json({ success: true });
        } else {
            res.json({ success: false, message: 'Payment not finished' });
        }
        
    } catch (error) {
        console.error('Webhook error:', error);
        res.status(500).json({ success: false });
    }
});

// 5. WEBHOOK FOR FLUTTERWAVE (Mobile money)
app.post('/webhook/flutterwave', async (req, res) => {
    try {
        const { status, amount, currency, customer, tx_ref } = req.body;
        
        if (status === 'successful') {
            // Extract user ID
            const userId = tx_ref.split('-')[1];
            
            // Convert to USD
            const usdAmount = convertToUSD(amount, currency);
            
            // Buy and send USDT
            const usdtResult = await buyUSDT(usdAmount);
            const transferResult = await sendUSDTToBinance(usdtResult.amountUSDT, `FLW ${userId}`);
            
            // Credit user
            await creditUserAccount(userId, usdAmount, transferResult.txHash);
            
            res.json({ success: true });
        }
        
    } catch (error) {
        console.error('FLW webhook error:', error);
        res.status(500).json({ success: false });
    }
});

// ==================== ADMIN ENDPOINTS ====================

// Get total deposits in Binance
app.get('/api/admin/binance-balance', async (req, res) => {
    // This would call Binance API to get real balance
    // For now, return from database
    
    const totalDeposits = 5000; // Sum of all deposits
    const totalWithdrawals = 500; // Sum of all withdrawals
    const currentBalance = totalDeposits - totalWithdrawals;
    
    res.json({
        totalDeposits,
        totalWithdrawals,
        currentBalance,
        address: BACKEND_CONFIG.BINANCE_ADDRESS
    });
});

// ==================== START SERVER ====================
const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
    console.log(`âœ… Backend server running on port ${PORT}`);
    console.log(`ðŸ’° Deposits auto-convert to USDT`);
    console.log(`ðŸ“¬ USDT destination: ${BACKEND_CONFIG.BINANCE_ADDRESS}`);
});

// ==================== USAGE EXAMPLE ====================
/*

FRONTEND CALL (from your app.js):

async function processUniversalDeposit() {
    const usdAmount = parseFloat(document.getElementById('depositUsdAmount').value);
    const category = document.getElementById('paymentCategory').value;
    const methodKey = document.getElementById('selectedPaymentMethod').value;
    
    let endpoint, payload;
    
    if (category === 'mobile') {
        endpoint = '/api/deposit/mobile-money';
        payload = {
            userId: getCurrentUserId(),
            phoneNumber: document.getElementById('phoneNumber').value,
            amount: amountInLocalCurrency,
            currency: method.currency,
            provider: methodKey
        };
    } else if (category === 'cards') {
        endpoint = '/api/deposit/card';
        payload = {
            userId: getCurrentUserId(),
            amount: usdAmount,
            cardToken: await getStripeToken()
        };
    } else if (category === 'crypto') {
        endpoint = '/api/deposit/crypto';
        payload = {
            userId: getCurrentUserId(),
            amount: amountInCrypto,
            currency: method.symbol,
            txHash: userProvidedTxHash
        };
    }
    
    // Call backend
    const response = await fetch('https://yourbackend.com' + endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    });
    
    const result = await response.json();
    
    if (result.success) {
        // Update user balance on frontend
        appState.displayBalance += result.usdAmount;
        updateUI();
        alert(`âœ… Deposit successful! $${result.usdAmount} added to your account`);
    }
}

*/
