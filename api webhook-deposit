import { createClient } from "@supabase/supabase-js";

const supabase = createClient(
  "https://YOUR_SUPABASE_URL.supabase.co",
  "YOUR_SERVICE_KEY"
);

export default async function handler(req, res) {
  const event = req.body;

  // Flutterwave successful payment
  if (event.event !== "charge.completed") {
    return res.json({ ignored: true });
  }

  const txRef = event.data.tx_ref;
  const amount = Number(event.data.amount);
  const status = event.data.status;

  if (status !== "successful") {
    return res.json({ failed: true });
  }

  // Get deposit
  const { data: deposit } = await supabase
    .from("deposits")
    .select()
    .eq("id", txRef)
    .single();

  if (!deposit || deposit.status === "confirmed") {
    return res.json({ duplicate: true });
  }

  // Mark deposit confirmed
  await supabase
    .from("deposits")
    .update({ status: "confirmed" })
    .eq("id", txRef);

  // Credit user balance
  await supabase.rpc("credit_balance", {
    uid: deposit.user_id,
    amt: amount
  });

  return res.json({ success: true });
}
